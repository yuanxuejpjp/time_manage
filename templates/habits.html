{% extends "base.html" %}

{% block title %}ä¹ æƒ¯æ‰“å¡ - æ—¶é—´æŒæ§è€…{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-check-circle"></i> ä¹ æƒ¯æ‰“å¡</h2>
            <div>
                <a href="{{ url_for('habits.calendar_view') }}" class="btn btn-outline-primary me-2">
                    <i class="bi bi-calendar3"></i> æ—¥å†è§†å›¾
                </a>
                <a href="{{ url_for('habits.stats') }}" class="btn btn-outline-primary">
                    <i class="bi bi-graph-up"></i> ç»Ÿè®¡åˆ†æ
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ä»Šæ—¥ä¹ æƒ¯æ‰“å¡ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sun"></i> ä»Šæ—¥ä¹ æƒ¯</h5>
            </div>
            <div class="card-body">
                {% if today_habits %}
                    <div class="row">
                        {% for item in today_habits %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 {% if item.checked %}border-success{% endif %}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="bi bi-{{ item.habit.icon }}"></i>
                                                    {{ item.habit.title }}
                                                </h6>
                                                <small class="text-muted">
                                                    {{ item.habit.frequency|frequency_filter }} Â·
                                                    ç›®æ ‡: {{ item.habit.target_value }}{{ item.habit.target_unit }}
                                                </small>
                                            </div>
                                            {% if item.checked %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check2"></i> å·²å®Œæˆ
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">å¾…å®Œæˆ</span>
                                            {% endif %}
                                        </div>

                                        {% if item.habit.description %}
                                            <p class="small text-muted mb-2">{{ item.habit.description }}</p>
                                        {% endif %}

                                        <div class="mb-2">
                                            <span class="badge bg-secondary">{{ item.habit.category }}</span>
                                            <span class="badge bg-info">
                                                <i class="bi bi-fire"></i> {{ item.habit.get_current_streak() }}å¤©
                                            </span>
                                        </div>

                                        <div class="mt-3">
                                            {% if item.checked %}
                                                <form method="POST" action="{{ url_for('habits.undo_checkin', habit_id=item.habit.id) }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-warning">
                                                        <i class="bi bi-x-circle"></i> å–æ¶ˆæ‰“å¡
                                                    </button>
                                                </form>
                                            {% else %}
                                                <a href="{{ url_for('habits.checkin', habit_id=item.habit.id) }}"
                                                   class="btn btn-sm btn-primary">
                                                    <i class="bi bi-check2"></i> ç«‹å³æ‰“å¡
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">ä»Šå¤©æ²¡æœ‰éœ€è¦å®Œæˆçš„ä¹ æƒ¯</p>
                        <p class="text-muted">åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªä¹ æƒ¯å§ï¼</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æ‰€æœ‰ä¹ æƒ¯åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-stars"></i> æˆ‘çš„ä¹ æƒ¯</h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHabitModal">
                    <i class="bi bi-plus-lg"></i> æ·»åŠ ä¹ æƒ¯
                </button>
            </div>
            <div class="card-body">
                {% if habits %}
                    <div class="row">
                        {% for habit in habits %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-{{ habit.icon }}"></i> {{ habit.title }}
                                            </h6>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-link" data-bs-toggle="dropdown">
                                                    <i class="bi bi-three-dots"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="{{ url_for('habits.edit_habit', habit_id=habit.id) }}">
                                                            <i class="bi bi-pencil"></i> ç¼–è¾‘
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <form method="POST" action="{{ url_for('habits.toggle_habit', habit_id=habit.id) }}">
                                                            <button type="submit" class="dropdown-item">
                                                                <i class="bi bi-{% if habit.is_active %}pause{% else %}play{% endif %}"></i>
                                                                {% if habit.is_active %}æš‚åœ{% else %}å¯ç”¨{% endif %}
                                                            </button>
                                                        </form>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form method="POST" action="{{ url_for('habits.delete_habit', habit_id=habit.id) }}"
                                                              onsubmit="return confirm('ç¡®å®šåˆ é™¤æ­¤ä¹ æƒ¯ï¼Ÿ')">
                                                            <button type="submit" class="dropdown-item text-danger">
                                                                <i class="bi bi-trash"></i> åˆ é™¤
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        {% if habit.description %}
                                            <p class="card-text small text-muted">{{ habit.description }}</p>
                                        {% endif %}

                                        <div class="mb-2">
                                            <span class="badge bg-secondary">{{ habit.category }}</span>
                                            <span class="badge bg-info">{{ habit.frequency|frequency_filter }}</span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">ç›®æ ‡: {{ habit.target_value }}{{ habit.target_unit }}</small>
                                                <br>
                                                <small class="text-muted">ç´¯è®¡: {{ habit.total_checkins }} æ¬¡</small>
                                            </div>
                                            <div class="text-end">
                                                <div class="text-primary">
                                                    <i class="bi bi-fire text-warning"></i> {{ habit.get_current_streak() }}å¤©
                                                </div>
                                                <small class="text-muted">è¿ç»­æ‰“å¡</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-star text-muted" style="font-size: 4rem;"></i>
                        <p class="text-muted mt-3">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¹ æƒ¯</p>
                        <p class="text-muted">åˆ›å»ºä¹ æƒ¯ï¼Œè®©å¥½ä¹ æƒ¯æˆä¸ºç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ï¼</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHabitModal">
                            <i class="bi bi-plus-lg"></i> åˆ›å»ºç¬¬ä¸€ä¸ªä¹ æƒ¯
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ ä¹ æƒ¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="addHabitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> æ·»åŠ æ–°ä¹ æƒ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('habits.add_habit') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">ä¹ æƒ¯åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="category" class="form-label">åˆ†ç±»</label>
                            <input type="text" class="form-control" id="category" name="category" list="habit-categories"
                                   value="è¿åŠ¨">
                            <datalist id="habit-categories">
                                <option value="è¿åŠ¨">
                                <option value="å­¦ä¹ ">
                                <option value="é˜…è¯»">
                                <option value="å†¥æƒ³">
                                <option value="æ—©èµ·">
                                <option value="å¥åº·é¥®é£Ÿ">
                                <option value="å…¶ä»–">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label for="icon" class="form-label">å›¾æ ‡</label>
                            <select class="form-select" id="icon" name="icon">
                                <option value="star">â­ æ˜Ÿæ˜Ÿ</option>
                                <option value="heart">â¤ï¸ çˆ±å¿ƒ</option>
                                <option value="fire">ğŸ”¥ ç«ç„°</option>
                                <option value="lightning">âš¡ é—ªç”µ</option>
                                <option value="sun">â˜€ï¸ å¤ªé˜³</option>
                                <option value="moon">ğŸŒ™ æœˆäº®</option>
                                <option value="book">ğŸ“š ä¹¦æœ¬</option>
                                <option value="bicycle">ğŸš´ è‡ªè¡Œè½¦</option>
                                <option value="droplet">ğŸ’§ æ°´æ»´</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                                  placeholder="ç®€å•æè¿°è¿™ä¸ªä¹ æƒ¯çš„ç›®æ ‡..."></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="frequency" class="form-label">é¢‘ç‡</label>
                            <select class="form-select" id="frequency" name="frequency" onchange="toggleWeeklyDays()">
                                <option value="daily">æ¯å¤©</option>
                                <option value="weekdays">å·¥ä½œæ—¥</option>
                                <option value="weekends">å‘¨æœ«</option>
                                <option value="weekly">æ¯å‘¨æŒ‡å®šå¤©</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="target_value" class="form-label">ç›®æ ‡å€¼</label>
                            <input type="number" class="form-control" id="target_value" name="target_value"
                                   value="1" step="0.1" min="0.1">
                        </div>
                        <div class="col-md-3">
                            <label for="target_unit" class="form-label">å•ä½</label>
                            <input type="text" class="form-control" id="target_unit" name="target_unit" value="æ¬¡"
                                   list="unit-list">
                            <datalist id="unit-list">
                                <option value="æ¬¡">
                                <option value="åˆ†é’Ÿ">
                                <option value="å°æ—¶">
                                <option value="é¡µ">
                                <option value="ç« ">
                                <option value="å…¬é‡Œ">
                            </datalist>
                        </div>
                    </div>

                    <div id="weekly-days-container" class="mb-3" style="display: none;">
                        <label class="form-label">é€‰æ‹©æ˜ŸæœŸ</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_days" value="0" id="day0">
                                <label class="form-check-label" for="day0">å‘¨ä¸€</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_days" value="1" id="day1">
                                <label class="form-check-label" for="day1">å‘¨äºŒ</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_days" value="2" id="day2">
                                <label class="form-check-label" for="day2">å‘¨ä¸‰</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_days" value="3" id="day3">
                                <label class="form-check-label" for="day3">å‘¨å››</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_days" value="4" id="day4">
                                <label class="form-check-label" for="day4">å‘¨äº”</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_days" value="5" id="day5">
                                <label class="form-check-label" for="day5">å‘¨å…­</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="target_days" value="6" id="day6">
                                <label class="form-check-label" for="day6">å‘¨æ—¥</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleWeeklyDays() {
    const frequency = document.getElementById('frequency').value;
    const weeklyDaysContainer = document.getElementById('weekly-days-container');
    weeklyDaysContainer.style.display = frequency === 'weekly' ? 'block' : 'none';
}
</script>
{% endblock %}
