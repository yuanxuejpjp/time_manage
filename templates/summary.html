{% extends "base.html" %}

{% block title %}{{ summary.summary_type|summary_type_filter }} - {{ summary.start_date|date_filter }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-file-text"></i>
                {{ summary.summary_type|summary_type_filter }}
            </h2>
            <a href="{{ url_for('summary.list_summaries') }}" class="btn btn-outline-secondary">返回列表</a>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">完成率</h5>
                <h2 class="text-primary">{{ summary.completion_rate }}%</h2>
                <p class="text-muted">{{ summary.completed_tasks }}/{{ summary.total_tasks }} 任务</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">总时长</h5>
                <h2 class="text-success">{{ summary.total_hours }}h</h2>
                <p class="text-muted">有效工作时间</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">时间范围</h5>
                <h4>{{ summary.start_date|date_filter }}</h4>
                <p class="text-muted">至 {{ summary.end_date|date_filter }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">报告类型</h5>
                <h4>{{ summary.summary_type|summary_type_filter }}</h4>
                <p class="text-muted">AI 分析</p>
            </div>
        </div>
    </div>
</div>

<!-- 分类统计图表 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> 时间分布（饼图）</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 各类时长（柱状图）</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI 总结与建议 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-robot"></i> AI 分析总结</h5>
            </div>
            <div class="card-body">
                {% if summary.ai_summary %}
                    <div class="mb-3">
                        <h6 class="text-primary">总体评价</h6>
                        <p class="text-pre-wrap">{{ summary.ai_summary }}</p>
                    </div>
                {% endif %}

                {% if summary.ai_suggestions %}
                    <div>
                        <h6 class="text-success">改进建议</h6>
                        <p class="text-pre-wrap">{{ summary.ai_suggestions }}</p>
                    </div>
                {% endif %}

                {% if not summary.ai_summary and not summary.ai_suggestions %}
                    <p class="text-muted">AI 分析暂不可用</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 用户心得 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-journal"></i> 我的心得</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('summary.add_notes', summary_id=summary.id) }}">
                    <div class="mb-3">
                        <textarea class="form-control" name="notes" rows="4"
                                  placeholder="记录这段时间的心得体会、经验教训...">{{ summary.user_notes or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> 保存心得
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 分类统计数据
const categoryStats = {{ category_stats|tojson }};
const labels = Object.keys(categoryStats);
const data = Object.values(categoryStats);

// 颜色配置
const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
];

// 饼图
new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
        labels: labels,
        datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length)
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// 柱状图
new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: '时长（小时）',
            data: data,
            backgroundColor: colors.slice(0, labels.length)
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: '小时'
                }
            }
        }
    }
});
</script>
{% endblock %}
