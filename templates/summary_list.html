{% extends "base.html" %}

{% block title %}æ€»ç»“æŠ¥è¡¨ - æ—¶é—´æŒæ§è€…{% endblock %}

{% block content %}
<!-- åŠ è½½é®ç½©å±‚ -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <p class="mt-3" style="font-size: 1.2rem;">ğŸ“Š æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</p>
        <p class="text-muted small">æ­£åœ¨æ•´ç†å¤ç›˜æ•°æ®ï¼Œè¯·ç¨å€™...</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-graph-up"></i> æ€»ç»“æŠ¥è¡¨</h2>
            <div>
                <form method="POST" action="{{ url_for('summary.generate_summary') }}" class="d-inline" onsubmit="showGenerating(event, 'æ—¥æŠ¥')">
                    <input type="hidden" name="type" value="daily">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-calendar-day"></i> ç”Ÿæˆæ—¥æŠ¥
                    </button>
                </form>
                <form method="POST" action="{{ url_for('summary.generate_summary') }}" class="d-inline" onsubmit="showGenerating(event, 'å‘¨æŠ¥')">
                    <input type="hidden" name="type" value="weekly">
                    <button type="submit" class="btn btn-outline-primary me-2">
                        <i class="bi bi-calendar-week"></i> ç”Ÿæˆå‘¨æŠ¥
                    </button>
                </form>
                <form method="POST" action="{{ url_for('summary.generate_summary') }}" class="d-inline" onsubmit="showGenerating(event, 'æœˆæŠ¥')">
                    <input type="hidden" name="type" value="monthly">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-calendar-month"></i> ç”ŸæˆæœˆæŠ¥
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">æ—¶é—´åˆ†å¸ƒï¼ˆè¿‘30å¤©ï¼‰</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="pieChart30"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">å„ç±»æ—¶é•¿å¯¹æ¯”</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="barChart30"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ‡æ¢ç»Ÿè®¡å‘¨æœŸ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" onclick="loadChartData('30')">è¿‘30å¤©</button>
            <button type="button" class="btn btn-outline-primary" onclick="loadChartData('90')">è¿‘90å¤©</button>
            <button type="button" class="btn btn-outline-primary" onclick="loadChartData('all')">å…¨éƒ¨æ—¶é—´</button>
        </div>
    </div>
</div>

<!-- æ€»ç»“åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">å†å²æŠ¥å‘Š</h5>
            </div>
            <div class="card-body">
                {% if summaries %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ç±»å‹</th>
                                    <th>æ—¶é—´èŒƒå›´</th>
                                    <th>å®Œæˆç‡</th>
                                    <th>æ€»æ—¶é•¿</th>
                                    <th>ç”Ÿæˆæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in summaries %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-info">{{ s.summary_type|summary_type_filter }}</span>
                                        </td>
                                        <td>{{ s.start_date|date_filter }} è‡³ {{ s.end_date|date_filter }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                    <div class="progress-bar" role="progressbar"
                                                         style="width: {{ s.completion_rate }}%"></div>
                                                </div>
                                                <small>{{ s.completion_rate }}%</small>
                                            </div>
                                        </td>
                                        <td>{{ s.total_hours }}h</td>
                                        <td>{{ s.created_at|datetime_filter }}</td>
                                        <td>
                                            <a href="{{ url_for('summary.view_summary', summary_id=s.id) }}"
                                               class="btn btn-sm btn-outline-primary">æŸ¥çœ‹</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark-text text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">è¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•æ€»ç»“</p>
                        <p class="text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆä½ çš„ç¬¬ä¸€ä»½æŠ¥å‘Š</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æ˜¾ç¤ºç”Ÿæˆä¸­çš„é®ç½©å±‚
function showGenerating(event, reportType) {
    event.preventDefault();
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'block';

    // è·å–è¡¨å•å¹¶æäº¤
    const form = event.target.form;
    const formData = new FormData(form);

    // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨ - 10ç§’è¶…æ—¶ï¼ˆç°åœ¨ä¸éœ€è¦AIï¼Œåº”è¯¥å¾ˆå¿«ï¼‰
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
        controller.abort();
        overlay.style.display = 'none';
        alert('ç”Ÿæˆè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
    }, 10000); // 10ç§’è¶…æ—¶

    // ä½¿ç”¨fetchæäº¤ï¼Œä»¥ä¾¿åœ¨å®Œæˆåè·³è½¬
    fetch(form.action, {
        method: 'POST',
        body: formData,
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        // æœåŠ¡å™¨ä¼šé‡å®šå‘åˆ°æ€»ç»“è¯¦æƒ…é¡µ
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.text().then(html => {
                // å¦‚æœæ²¡æœ‰é‡å®šå‘ï¼Œæ‰‹åŠ¨è§£æå“åº”å¹¶è·³è½¬
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const summaryLink = doc.querySelector('a[href*="/summary/"]');
                if (summaryLink) {
                    window.location.href = summaryLink.href;
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°é“¾æ¥ï¼Œåˆ·æ–°é¡µé¢
                    window.location.reload();
                }
            });
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('Error:', error);
        overlay.style.display = 'none';
        if (error.name === 'AbortError') {
            // è¶…æ—¶é”™è¯¯å·²åœ¨ä¸Šé¢å¤„ç†
        } else {
            alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message + '\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
        }
    });
}

let pieChart, barChart;

function loadChartData(period) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(period === 'all' ? 'å…¨éƒ¨' : period + 'å¤©')) {
            btn.classList.add('active');
        }
    });

    // è·å–æ•°æ®
    fetch(`{{ url_for('summary.chart_data') }}?period=${period}`)
        .then(res => res.json())
        .then(data => {
            updateCharts(data.labels, data.data);
        });
}

function updateCharts(labels, data) {
    if (pieChart) pieChart.destroy();
    if (barChart) barChart.destroy();

    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];

    pieChart = new Chart(document.getElementById('pieChart30'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    barChart = new Chart(document.getElementById('barChart30'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'æ—¶é•¿ï¼ˆå°æ—¶ï¼‰',
                data: data,
                backgroundColor: colors.slice(0, labels.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'å°æ—¶' }
                }
            }
        }
    });
}

// åˆå§‹åŠ è½½
loadChartData('30');
</script>
{% endblock %}
